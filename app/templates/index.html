{% extends "base.html" %}

{% block title %}Главная - Мониторинг инфраструктуры{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-speedometer2"></i> Дашборд мониторинга
        </h1>
    </div>
</div>

<!-- Статистические карточки -->
<div class="row mb-4">
    <!-- VPN -->
    <div class="col-md-4 mb-3">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-lock"></i> VPN (IKEv2)
                </h5>
            </div>
            <div class="card-body position-relative">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-primary">{{ stats.vpn_active }}</h3>
                            <small class="text-muted">Активных</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-info">{{ stats.vpn_total_today }}</h3>
                            <small class="text-muted">За сегодня</small>
                        </div>
                    </div>
                </div>
                {% if vpn_users %}
                <div class="mt-2 small">
                    <strong>Сейчас:</strong>
                    {% for u in vpn_users %}
                      <a href="{{ url_for('vpn.user_detail', username=u.username) }}" class="me-2">{{ u.username }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="mt-3">
                    <a href="{{ url_for('vpn.index') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-right"></i> Подробнее
                    </a>
                </div>
                <a href="{{ url_for('vpn.index') }}" class="stretched-link" aria-label="Открыть VPN"></a>
            </div>
        </div>
    </div>

    <!-- RDP -->
    <div class="col-md-4 mb-3">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pc-display"></i> RDP
                </h5>
            </div>
            <div class="card-body position-relative">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-success">{{ stats.rdp_active }}</h3>
                            <small class="text-muted">Активных</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-info">{{ stats.rdp_total_today }}</h3>
                            <small class="text-muted">За сегодня</small>
                        </div>
                    </div>
                </div>
                {% if rdp_users %}
                <div class="mt-2 small">
                    <strong>Сейчас:</strong>
                    {% for u in rdp_users %}
                      <a href="{{ url_for('rdp.user_history', username=u.username) }}" class="me-2" title="{{ u.collection_name or '' }}">{{ u.username }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="mt-3">
                    <a href="{{ url_for('rdp.index') }}" class="btn btn-success btn-sm">
                        <i class="bi bi-arrow-right"></i> Подробнее
                    </a>
                </div>
                <a href="{{ url_for('rdp.index') }}" class="stretched-link" aria-label="Открыть RDP"></a>
            </div>
        </div>
    </div>

    <!-- SMB -->
    <div class="col-md-4 mb-3">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="bi bi-folder"></i> SMB
                </h5>
            </div>
            <div class="card-body position-relative">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-warning">{{ stats.smb_active }}</h3>
                            <small class="text-muted">Открытых файлов</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-info">{{ stats.smb_users_active }}</h3>
                            <small class="text-muted">Активных пользователей</small>
                        </div>
                    </div>
                </div>
                {% if smb_files %}
                <div class="mt-2 small">
                    <strong>Сейчас:</strong>
                    {% for f in smb_files %}
                      <a href="{{ url_for('smb.download_file', file_id=f.id) }}" class="me-2" title="{{ f.full_path }}">{{ f.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="mt-3">
                    <a href="{{ url_for('smb.index') }}" class="btn btn-warning btn-sm">
                        <i class="bi bi-arrow-right"></i> Подробнее
                    </a>
                </div>
                <a href="{{ url_for('smb.index') }}" class="stretched-link" aria-label="Открыть SMB"></a>
            </div>
        </div>
    </div>
</div>

<!-- MikroTik summary -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card border-info">
      <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0"><i class="bi bi-hdd-network"></i> Устройства MikroTik</h5>
      </div>
      <div class="card-body position-relative">
        <div class="row text-center">
          <div class="col-6">
            <div class="h3 mb-0">{{ stats.mt_devices }}</div>
            <small class="text-muted">Устройств</small>
          </div>
          <div class="col-6">
            <div class="h3 mb-0">{{ stats.mt_if_addrs }}</div>
            <small class="text-muted">IP-адресов на интерфейсах</small>
          </div>
        </div>
        <div class="mt-3">
          <a href="{{ url_for('vpn.interfaces') }}" class="btn btn-info btn-sm"><i class="bi bi-list-columns-reverse"></i> Таблица адресов</a>
        </div>
        <a href="{{ url_for('vpn.interfaces') }}" class="stretched-link" aria-label="Открыть таблицу адресов MikroTik"></a>
      </div>
    </div>
  </div>
  
</div>

<!-- Быстрые действия -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> Быстрые действия
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('vpn.topology') }}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-diagram-3"></i><br>
                            <small>Топология MikroTik</small>
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('vpn.interfaces') }}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-hdd-network"></i><br>
                            <small>Адреса интерфейсов</small>
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('rdp.sessions_history') }}" class="btn btn-outline-success w-100">
                            <i class="bi bi-clock-history"></i><br>
                            <small>История RDP</small>
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('smb.files_open_now') }}" class="btn btn-outline-warning w-100">
                            <i class="bi bi-file-earmark-text"></i><br>
                            <small>Открытые файлы</small>
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('api.docs') }}" class="btn btn-outline-info w-100">
                            <i class="bi bi-code-slash"></i><br>
                            <small>API документация</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Системная информация -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Системная информация
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><strong>Версия:</strong> <span id="version">{{ app_version or 'unknown' }}</span></li>
                    <li><strong>Данные с:</strong> <span>{{ db_start_date or 'неизвестно' }}</span></li>
                    <li><strong>Время работы:</strong> <span id="uptime">Загрузка...</span></li>
                    <li><strong>Последнее обновление:</strong> <span id="last-update">Загрузка...</span></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-activity"></i> Состояние системы
                </h6>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Загрузка состояния системы
function loadSystemStatus() {
    fetch('/health')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('system-status');
            let html = '';
            
            for (const [db, status] of Object.entries(data.databases)) {
                const badgeClass = status === 'ok' ? 'bg-success' : 'bg-danger';
                html += `<span class="badge ${badgeClass} me-2">${db.toUpperCase()}: ${status}</span>`;
            }
            
            statusDiv.innerHTML = html;

            // Обновляем версию, uptime и last-update
            const uptimeSpan = document.getElementById('uptime');
            const lastSpan = document.getElementById('last-update');
            const versionSpan = document.getElementById('version');
            if ('uptime_seconds' in data && uptimeSpan) {
                const s = data.uptime_seconds || 0;
                const h = Math.floor(s / 3600);
                const m = Math.floor((s % 3600) / 60);
                const sec = s % 60;
                uptimeSpan.textContent = `${h}ч ${m}м ${sec}с`;
            }
            if ('last_update' in data && lastSpan) {
                const d = new Date(data.last_update);
                lastSpan.textContent = d.toLocaleString('ru-RU');
            }
            if ('version' in data && versionSpan) {
                versionSpan.textContent = data.version || 'unknown';
            }
        })
        .catch(error => {
            document.getElementById('system-status').innerHTML = 
                '<span class="badge bg-danger">Ошибка загрузки</span>';
        });
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStatus();
    
    // Обновление
    setInterval(loadSystemStatus, 60000);
});
</script>
{% endblock %}
