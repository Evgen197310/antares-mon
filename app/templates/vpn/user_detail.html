{% extends "base.html" %}

{% block title %}VPN: История пользователя {{ username }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-3">
    <div class="col-12">
      <h2 class="mb-0">
        <i class="fas fa-user-shield text-primary"></i>
        История сессий: {{ username }}
      </h2>
    </div>
  </div>

  <!-- Фильтры периода -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="btn-group" role="group">
        <a class="btn btn-outline-secondary {% if days == 0 %}active{% endif %}" href="{{ url_for('vpn.user_detail', username=username, days=0) }}">Все время</a>
        <a class="btn btn-outline-secondary {% if days == 1 %}active{% endif %}" href="{{ url_for('vpn.user_detail', username=username, days=1) }}">Сегодня</a>
        <a class="btn btn-outline-secondary {% if days == 7 %}active{% endif %}" href="{{ url_for('vpn.user_detail', username=username, days=7) }}">Неделя</a>
        <a class="btn btn-outline-secondary {% if days == 30 %}active{% endif %}" href="{{ url_for('vpn.user_detail', username=username, days=30) }}">30 дней</a>
        <a class="btn btn-outline-secondary {% if days == 365 %}active{% endif %}" href="{{ url_for('vpn.user_detail', username=username, days=365) }}">Год</a>
      </div>
    </div>
  </div>

  <!-- Сводка -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Всего сессий</div>
          <div class="h4 mb-0">{{ stats.total_sessions or 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Активных сейчас</div>
          <div class="h4 mb-0">{{ stats.active_sessions or 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Средняя длительность</div>
          <div class="h4 mb-0">{% if stats.avg_duration %}{{ stats.avg_duration|duration_format }}{% else %}—{% endif %}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="small text-muted">Суммарное время</div>
          <div class="h4 mb-0">{% if stats.total_duration %}{{ stats.total_duration|duration_format }}{% else %}—{% endif %}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Таблица сессий -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-history"></i> Сессии пользователя</span>
          <span class="text-muted small">Период: {{ days }} дн.</span>
        </div>
        <div class="card-body">
          {% if sessions %}
          <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
              <thead>
                <tr>
                  <th class="text-nowrap">Внешний IP</th>
                  <th class="text-nowrap">Внутренний IP</th>
                  <th class="text-nowrap">Начало</th>
                  <th class="text-nowrap">Конец</th>
                  <th class="text-nowrap">Длительность</th>
                </tr>
              </thead>
              <tbody>
                {% for s in sessions %}
                <tr>
                  <td><code class="text-danger">{{ s.outer_ip or '—' }}</code></td>
                  <td><code>{{ s.inner_ip or '—' }}</code></td>
                  <td class="text-nowrap">
                    {% if s.time_start %}{{ s.time_start|datetime_format('%d.%m.%Y %H:%M:%S') }}{% else %}—{% endif %}
                  </td>
                  <td class="text-nowrap">
                    {% if s.time_end %}{{ s.time_end|datetime_format('%d.%m.%Y %H:%M:%S') }}{% else %}<span class="badge bg-success">Активна</span>{% endif %}
                  </td>
                  <td>
                    {% if s.time_end %}
                      {% if s.duration %}{{ s.duration|duration_format }}{% else %}—{% endif %}
                    {% else %}
                      <span class="badge bg-info text-dark vpn-live-duration" data-start-iso="{{ (s.time_start.isoformat() if s.time_start else '') }}">—</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Пагинация -->
          <nav aria-label="VPN user pages" class="mt-3">
            <ul class="pagination mb-0">
              <li class="page-item {% if not has_prev %}disabled{% endif %}">
                <a class="page-link" href="{% if has_prev %}{{ url_for('vpn.user_detail', username=username, days=days, page=prev_num) }}{% else %}#{% endif %}">Назад</a>
              </li>
              <li class="page-item disabled"><span class="page-link">Стр. {{ page }}</span></li>
              <li class="page-item {% if not has_next %}disabled{% endif %}">
                <a class="page-link" href="{% if has_next %}{{ url_for('vpn.user_detail', username=username, days=days, page=next_num) }}{% else %}#{% endif %}">Вперёд</a>
              </li>
            </ul>
          </nav>
          {% else %}
            <div class="alert alert-info mb-0 text-center">Нет записей за выбранный период.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    try{
      const serverNowIso = '{{ server_now|default("") }}';
      const serverNow = serverNowIso ? new Date(serverNowIso) : new Date();
      const clientStart = new Date();
      function fmt(ms){
        if (!ms || ms < 0) ms = 0;
        const s = Math.floor(ms/1000);
        const h = Math.floor(s/3600);
        const m = Math.floor((s%3600)/60);
        return h>0? `${h} ч ${m} м` : `${m} м`;
      }
      function tick(){
        const now = new Date();
        const eff = new Date(serverNow.getTime() + (now - clientStart));
        document.querySelectorAll('.vpn-live-duration').forEach(el=>{
          const iso = el.getAttribute('data-start-iso');
          if (!iso) return;
          const start = new Date(iso);
          el.textContent = fmt(eff - start);
        });
      }
      tick();
      setInterval(tick, 30000);
    }catch(e){}
  })();
  </script>
</div>
{% endblock %}
