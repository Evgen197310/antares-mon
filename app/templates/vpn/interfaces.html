{% extends "base.html" %}

{% block title %}Адреса интерфейсов MikroTik{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="mb-3"><i class="bi bi-hdd-network"></i> Адреса интерфейсов MikroTik</h1>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="h4 mb-0">{{ device_count }}</div>
        <small class="text-muted">Устройств</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="h4 mb-0">{{ interface_count }}</div>
        <small class="text-muted">Интерфейсов</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="h4 mb-0">{{ address_count }}</div>
        <small class="text-muted">IP-адресов</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <a href="{{ url_for('vpn.mikrotik_topology') }}" class="btn btn-outline-primary w-100"><i class="bi bi-diagram-3"></i> Топология</a>
      </div>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6 mb-2">
    <input id="flt" class="form-control" placeholder="Фильтр: устройство / интерфейс / адрес / тип" />
  </div>
  <div class="col-md-6 mb-2 text-end">
    <a href="{{ url_for('main.index') }}" class="btn btn-light"><i class="bi bi-arrow-left"></i> На дашборд</a>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle" id="mt-table">
    <thead class="table-light">
      <tr>
        <th style="width: 28%">Устройство</th>
        <th style="width: 22%">Интерфейс</th>
        <th style="width: 35%">Адрес</th>
        <th style="width: 15%">Тип</th>
      </tr>
    </thead>
    <tbody>
      {% for g in groups %}
        <tr class="table-secondary" data-type="group">
          <td colspan="4">
            <strong><a href="{{ url_for('vpn.interfaces', identity=g.identity) }}" class="text-decoration-none">{{ g.identity }}</a></strong>
          </td>
        </tr>
        {% for r in g.items %}
        <tr data-type="item">
          <td></td>
          <td>{{ r.iface or '-' }}</td>
          <td><code>{{ r.ip or '-' }}</code></td>
          <td>{{ r.type or '-' }}</td>
        </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
  {% if not groups or groups|length == 0 %}
    <div class="alert alert-warning mt-2">Нет данных для отображения.</div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Фильтр: если совпало имя устройства (строка-группа), показываем всю группу
const input = document.getElementById('flt');
const table = document.getElementById('mt-table');
if (input && table) {
  input.addEventListener('input', function () {
    const q = this.value.trim().toLowerCase();
    let currentGroupVisible = true;
    for (const tr of table.tBodies[0].rows) {
      const type = tr.dataset.type || 'item';
      const txt = tr.innerText.toLowerCase();
      if (type === 'group') {
        const match = q === '' || txt.indexOf(q) >= 0;
        currentGroupVisible = match;
        tr.style.display = match ? '' : (q === '' ? '' : 'none');
      } else {
        const rowMatch = q === '' || txt.indexOf(q) >= 0;
        tr.style.display = (currentGroupVisible || rowMatch) ? '' : 'none';
      }
    }
  });
}
</script>
{% endblock %}
